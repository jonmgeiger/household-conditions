---
title: "Public School Tidy and Join"
author: "John Geiger, Noel Goodwin, Abigail Joppa"
date: "`r Sys.Date()`"
output: openintro::lab_report
---

```{r load-packages, message=FALSE}
library(tidyverse)
library(tidylog)
library(openintro)
```


### Import data

```{r, message=FALSE}
public_schools <- read_csv("Public_Schools.csv")
grad_race_HH <- read_csv("https://github.com/jonmgeiger/household-conditions/raw/main/data/grad_race_household.csv")
View(grad_race_HH)

```

Because there are schools included in this dataset that are not in the US, we are going to filter out all schools that are not in the US. Additionally, lets get rid of any variables that are irrelevant to our join with the household data or future analyses. 
```{r}

US_PS <- public_schools %>%
  filter(COUNTRY == "USA") %>%
  select(-X, 
         -Y, 
         -ZIP4, 
         -(TELEPHONE:STATUS), 
         -COUNTRY, 
         -(SOURCEDATE:WEBSITE), 
         -SOURCE, 
         -SHELTER_ID, 
         -NAICS_CODE, 
         -NAICS_DESC)

```



In order to join these schools with their coinciding school district, we must match both the LEAID (district ID) from the household district data to the first 7 digits of the NCEID (LEAID + unique school ID). Note: the variable titled DISTRICTID does not match any district id included in the household dataset. 
```{r}
US_PS <- US_PS %>%
  separate(col = NCESID, into = c("LEAID", "other_school_code"), sep = 7) 
```



### Join household data with the public school data. 

Now that we separated the NCESID, we are able to join using the LEAID (district ID). 
```{r}
school_dist_join <- US_PS %>%
  left_join(grad_race_HH, by = c("LEAID" = "LEAID", "STATE" = "abbr_state"))
```

There appears to be 11769 schools in the public school dataset that do not have coinciding school districts documented in the household dataset. 

```{r}
school_dist_join %>%
  is.na() %>%
  colSums()

school_dist_join%>%
  filter(is.na(dist))
```

### Remove irrelavent variables 

Lets clean up the dataset by getting rid of any useless variables. 
```{r}

school_dist_clean <- school_dist_join %>%
  select(-OBJECTID, 
         -other_school_code, 
         -ADDRESS, 
         -LATITUDE, 
         -LONGITUDE, 
         -FT_TEACHER, 
         -school_ID,
         -ZIP, 
         -STATE, 
         -year)%>%
  relocate(where(is.numeric), .after = where(is.character))%>%
  relocate(dist, .after = NAME)
  
```

### Quick look into education levels

Lets take a look at what levels of education exist in the data set so we can try to isolate the districts with high schools. Based on the level variable, we can see that there are 22886 schools categorized as high schools. 

```{r}
school_dist_clean%>%
  count(LEVEL_) 
```

Additionally, there are also quite a few schools that are considered "other" that include K-12 schools with graduation rates, as well as many of the "secondary" schools. 

```{r}
school_dist_clean %>% 
  filter(LEVEL_ == "OTHER")%>%
  select(NAME, dist, ST_GRADE, END_GRADE, grad_rate_midpt)

school_dist_clean %>% 
  filter(LEVEL_ == "SECONDARY")%>%
  select(NAME, dist, ST_GRADE, END_GRADE, grad_rate_midpt)
```

Using the end grade variable as a marker of high schools, there are 26366 schools that end with grade 12 (3480 more schools than are included in the "HIGH" category".

```{r}
school_dist_clean%>%
  count(END_GRADE) 

```

### Possible filtering method

This inconsistency in the dataset bares the question of how we are going to accurately filter the dataset to only include high schools. One option is to include schools that end in grade 12 OR are classified as high schools. This would include some of schools that appear to be high schools but are categorized as "other", "secondary" or "middle". If we did this, this is how it would work.

```{r}
high_dist <- school_dist_clean %>%
  filter(END_GRADE == "12" | LEVEL_ == "HIGH")

high_dist%>%
  count(LEVEL_) 
```
This removed 74,498 schools, leaving only 26,457 schools in the data set that are likely high schools. This included most of the schools in the "other" category, as well as four schools categorized as "middle".


